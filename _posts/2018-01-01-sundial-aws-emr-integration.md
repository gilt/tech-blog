---
layout: post
title: "Sundial AWS EMR Integration"
author: Giovanni Gargiulo
date: '2018-01-01'
categories: 
- aws
- emr
tags:
- aws
- sundial
- pagerduty
---

# AWS Elastic Map Reduce on Sundial

Today I want to talk about a recent improvement we implemented in [Sundial](https://github.com/gilt/sundial), an Open Source product launched in Gilt in early 2016.

For those of you that are not familiar with it, [Sundial](https://github.com/gilt/sundial) is a batch job scheduler that works with Amazon ECS and Amazon Batch.

As the data we're are dealing with here in my team is growing every day more, we've found out that our Aster cluster is starting to hit scalability issues.
Because the same cluster is also used to run jobs for BI tools, it's easy to imagine how, in particular moments of the week like monday morning, users may experience dramatic performance degradation. 
The result is obvious, our nightly job are finishing every day later, and BI folks are getting quite frustrated because of their reports taking longer and longer to being built. 
This is of course significantly affecting user experience and productivity.

For this reason we decided to adopt [AWS EMR (Elastic Map Reduce)](https://aws.amazon.com/emr/) for our ETL jobs.



A few months ago, Gilt Tech announced [Sundial](https://github.com/gilt/sundial). Sundial is an open source batch job scheduler for Amazon ECS.
Over the course of the last few months, Sundial has seen a significant adoption both inside and outside of Gilt.

Until Sundial v0.0.10, emailing was the only way of notifying job failures.

At the beginning when the number of jobs running on Sundial was small (and so was the number of failures!), it was fairly easy to spot emails of failed jobs and act accordingly.

Lately though, in the Personalization Team, Sundial schedules about a thousand job executions per day and it's easy to imagine the amount of noise in our inbox generated by job notifications.
 
Beside the noise, it has happened more than once that failure of critical jobs went unnoticed. This was of course unacceptable.
 
Since [PagerDuty](https://www.pagerduty.com/) is the _de facto_ standard in Gilt when it comes to _on call procedures_ and since PagerDuty offers a nice and reliable events [API](https://v2.developer.pagerduty.com/docs/events-api), we've redesigned the notification mechanism 
and integrated PagerDuty with Sundial.  

## Configuring PagerDuty on Sundial

Configuring your job to support both Emails and PagerDuty notifications is very straightforward and can be done by adding the following json snippet to your job definition:

```json
{
"notifications": [
    {
      "email": {
        "name": "name",
        "email": "email",
        "notify_when": "on_state_change_and_failures"
      }
    },
    {
      "pagerduty": {
        "service_key": "my_pd_service_key",
        "num_consecutive_failures": 3,
        "api_url": "https://events.pagerduty.com"
      }
    }
  ]
}
```

Where 

* _notify_when_ defines when email notifications will be sent. Possible values are:
  * _always_, Always notify when a process completes
  * _on_failure_, Notify when a process fails
  * _on_state_change_, Notify when a process goes from succeeding to failing and vice versa
  * _on_state_change_and_failures_, Notify when going from failing to succeeded and on each failure
  * _never_
* _my_pd_service_key_ is the key obtained in the _Service Page_ in PagerDuty
* _num_consecutive_failures_ is the number of consecutive failures after which Sundial will trigger an alert in PagerDuty

Please note that the `subscriptions` object in the Process Definition json has been deprecated, so if you've already adopted Sundial and want to start using the new `notifications`, you will have to 
 update your json accordingly. 

More details can be found in the [Sundial v.0.0.10 release page](https://github.com/gilt/sundial/releases/tag/v0.0.10)
