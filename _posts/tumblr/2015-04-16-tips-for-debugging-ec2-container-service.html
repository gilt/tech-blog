---
layout: post
title: Tips for Debugging EC2 Container Service
date: '2015-04-16T11:14:19-04:00'
author: Scott Thompson
category: aws
tags:
- ecs
- Docker
- elastic container service
- Amazon Web Services
- aws
tumblr_url: http://tech.gilt.com/post/116560048224/tips-for-debugging-ec2-container-service
---
<p>Last week, Amazon made their <a href="http://aws.amazon.com/ecs" target="_blank">Elastic Container Service</a> generally available and also released a web UI to make it easier to create tasks. This service was exciting for our personalization team as we wanted to leverage ECS to simplify deployment of our jobs and have better control over failures.<br/></p><p><b></b></p><p>Getting started with ECS is easy but requires your full attention because there are a lot of important details (did you remember to set the correct IAM roles for your container instances?). If you haven’t done so already, make sure you go through the <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/get-set-up-for-amazon-ecs.html" target="_blank">Getting Started documentation</a>.</p><p>Once you’re ready to run your task what to do if something fails or doesn’t go as planned? Here are some of our experiences debugging ECS tasks.</p><h2>Start with a simple application</h2><p>In our case we created a Scala main method with very few dependencies. A sleep method is sufficient to simulate a job running and should provide enough time to see our container running.<br/></p><figure data-orig-width="298" data-orig-height="81"><img src="https://40.media.tumblr.com/79d194eba676f73f0eb93559dd84484e/tumblr_inline_nmwny6vMRY1sjs9t1_540.png" alt="image" data-orig-width="298" data-orig-height="81"/></figure><h2><br/></h2><h2>Make sure your cluster has at least one container instance</h2><p><b></b></p><p>Your ECS cluster requires at least one container instance to run your container. You can check the web console to make sure there is at least one running.</p><figure data-orig-width="1130" data-orig-height="230" class="tmblr-full"><img src="https://40.media.tumblr.com/906b5806efef5d749370cdd7c171f436/tumblr_inline_nmwnxhRQI61sjs9t1_540.png" alt="image" data-orig-width="1130" data-orig-height="230"/></figure><p>If you don’t see your instances here make sure you’ve followed the <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/launch_container_instance.html" target="_blank">Container Instance documentation</a>. In particular that you launched an instance with the <b>correct ECS AMI</b>, that you have attached the <b>correct IAM role</b> and that you have <b>pointed your instance to your cluster</b>.<br/></p><p><br/></p><h2>Inspect the ECS logs</h2><p><b></b></p><p>Once your container instance is attached to your cluster there will be an ecs-agent running on the machine. (note: the ecs-agent is open source and on <a href="https://github.com/aws/amazon-ecs-agent" target="_blank">github</a> so you may be able to find help on the ‘issues’ page if needed ). The ecs-agent emits logs that can help you debug. You will need to ssh to the container instance and inspect the ecs-agent log:</p><p><b>/var/log/ecs/ecs-agent.log</b></p><p>For example, when inspecting this log it can be useful to know that the agent has pulled your docker image:</p><p><i>t=2015-04-14T15:46:53+0000 lvl=dbug msg=&ldquo;Pulling image&rdquo; module=TaskEngine image=&lt;my-registry.my-domain&gt;.com/&lt;my-image&gt;:latest status=&ldquo;Pulling dependent layers&rdquo;</i></p><p><i><br/></i></p><h2>Make sure the container instance installed your docker image</h2><p>You can check to make sure the ecs-agent successfully downloaded your docker image. ssh to your container instance and run <b>docker images</b>. Your docker image should appear in this list.</p><figure data-orig-width="1999" data-orig-height="179" class="tmblr-full"><img src="https://40.media.tumblr.com/166cf3a403ed251a125f111a3ee42f5a/tumblr_inline_nmwo2asTgX1sjs9t1_540.png" alt="image" data-orig-width="1999" data-orig-height="179"/></figure><p>If you don’t see your image check the ecs-agent logs and make sure your container instance is able to contact your docker registry by curling the registry and printing out the available tags:<br/></p><p>curl &rsquo;<a href="https://docker-registry.gilt.com/v1/repositories/cerebro/svc-cerebro-job/tags" target="_blank">https://&lt;my-registry.my-domain&gt;.com/v1/repositories/&lt;my-image&gt;/tags</a>&rsquo;</p><h2><br/></h2><h2>Manually start your docker image</h2><p>Checking to see if your image can be run from the command line is a great way to make sure the image can be run on the container instance. This also gives you an opportunity to inspect the application logs. For example,</p><p><b>docker run -it docker-registry.gilt.com/cerebro/svc-cerebro-job:latest bin/cerebro_ngram_job.sh production</b></p><p><b><br/></b></p><h2>Check for failed container processes</h2><p>If your container can be run from the command line but is still not being run automatically through ECS Run Task then it’s likely you have something wrong in your ECS Task Definition. Check for failed container processes and inspect their container configuration. </p><p>To check for failed containers run <b>docker ps -a</b>.</p><p>Once you have the Container ID you can inspect the docker configuration. If you see an exit code other than 0 there may be an issue with your container configuration. </p><p><b>docker inspect &lt;containerId&gt;</b></p><p>For example, I noticed an exit code of 127 which indicates a bad command. This led me to fix a bug in the task definition CMD field that requires commands to be passed in json array format.</p><p>Finally, you can inspect the application log of the container.</p><p><b>docker logs &lt;containerId&gt;</b><br/></p><p>For reference, here is a working task definition:</p><figure data-orig-width="1080" data-orig-height="586" class="tmblr-full"><img src="https://40.media.tumblr.com/3d9d3e703c573258e186924460146e79/tumblr_inline_nmwo1lwajJ1sjs9t1_540.png" alt="image" data-orig-width="1080" data-orig-height="586"/></figure>
